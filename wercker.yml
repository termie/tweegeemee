no-response-timeout: 60
command-timeout: 60

# Run this on a cronjob
gen-urls:
  box: python:2.7
  steps:
    - termie/auto
    - pip-install
    - script:
        name: generate the urls and filter
        code: |
          python gen_urls.py > urls
    - script:
        name: trigger the runs
        code: |
          cat urls
          for x in $(cat urls); do
            ./manual.sh $x
          done

# Run this for each new url
gen-code:
  box: python:2.7
  steps:
    - script:
        name: check for tgm url
        code: |
          if [ -z "$TGM_URL" ]; then
            echo "No TGM_URL, aborting" > $WERCKER_REPORT_MESSAGE_FILE
            false
          fi
    - pip-install
    - script:
        code: |
          python gen_code.py $TGM_URL > src/tweegeemee/onetime.clj


# This chains from gen-code
gen-image:
  box: clojure
  steps:
    - script:
        code: |
          lein run -m tweegeemee.onetime/mymain
          ls -lah
          cp output.png $WERCKER_REPORT_ARTIFACTS_DIR/
          cp output.png $WERCKER_OUTPUT_DIR/$TGM_NAME.png

upload-image:
  box: debian
  steps:
    - s3sync:
        delete-removed: false
        bucket-url: $AWS_BUCKET
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
